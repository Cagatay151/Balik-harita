<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<title>Canlı Balık Haritası</title>

<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
/>
<style>
#map { height: 100vh; }

.leaflet-control.legend {
  background: white;
  padding: 10px;
  border-radius: 6px;
  box-shadow: 0 0 10px rgba(0,0,0,0.3);
  font-size: 14px;
  line-height: 18px;
}
</style>

<!-- Turf.js ekliyoruz -->
<script src="https://unpkg.com/@turf/turf/turf.min.js"></script>
</head>

<body>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
const map = L.map("map").setView([36.5, 30.5], 8);

L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
  maxZoom: 18
}).addTo(map);

/* ============================= */
/* Kara poligonu (simplified örnek) */
const landGeoJSON = {
  "type": "FeatureCollection",
  "features": [
    {
      "type": "Feature",
      "properties": {},
      "geometry": {
        "type": "Polygon",
        "coordinates": [[
          [29.9, 36.0],
          [31.0, 36.0],
          [31.0, 37.5],
          [29.9, 37.5],
          [29.9, 36.0]
        ]]
      }
    }
  ]
};

/* ============================= */
/* Turf.js destekli denize kaydırma */
function denizeKaydirTurf(lat, lon) {
  let point = turf.point([lon, lat]);
  const karada = turf.booleanPointInPolygon(point, landGeoJSON.features[0]);

  if (!karada) return [lat, lon]; // Zaten denizdeyse dokunma

  // Karadaysa denize kaydır
  const metre = Math.random() * (300 - 80) + 80;
  const derece = metre / 111000;
  const aci = Math.random() * 2 * Math.PI;

  const dLat = Math.sin(aci) * derece;
  const dLon = Math.cos(aci) * derece;

  return [lat + dLat, lon + dLon];
}

/* ============================= */
/* CSV’den marker ekleme */
fetch("2.csv")
.then(res => res.text())
.then(text => {
  const rows = text.trim().split("\n").slice(1);

  rows.forEach(line => {
    const parts = line.split(";");
    if (parts.length < 3) return;

    const tur = parts[0];
    const lat = parseFloat(parts[1]);
    const lon = parseFloat(parts[2]);
    if (isNaN(lat) || isNaN(lon)) return;

    const yeni = denizeKaydirTurf(lat, lon);

    let renk = "gray";
    if (tur.includes("Balon")) renk = "red";
    if (tur.includes("Aslan")) renk = "orange";
    if (tur.includes("Sokar")) renk = "blue";

    L.circleMarker(yeni, {
      radius: 6,
      color: renk,
      fillColor: renk,
      fillOpacity: 0.8
    }).addTo(map);
  });
});

/* ============================= */
/* Legend */
const legend = L.control({ position: "bottomright" });
legend.onAdd = function () {
  const div = L.DomUtil.create("div", "legend");
  div.innerHTML = `
    <b>Balık Türleri</b><br>
    <span style="color:red;font-size:18px;">●</span> Balon Balığı<br>
    <span style="color:orange;font-size:18px;">●</span> Aslan Balığı<br>
    <span style="color:blue;font-size:18px;">●</span> Sokar Balığı<br>
    <span style="color:gray;font-size:18px;">●</span> Diğer Türler
  `;
  return div;
};
legend.addTo(map);

</script>
</body>
</html>
